<viewer-count transition:persist>
  <span class="count"><span class="leading-zeros">00</span>1</span> watching
</viewer-count>

<style>
  viewer-count {
    display: flex;
    align-items: center;
    gap: 0.4em;
    color: var(--phosphor-active);
    text-shadow: var(--phosphor-glow);
  }

  :global([data-power="off"]) viewer-count {
    color: var(--phosphor-inactive);
    text-shadow: none;
  }

  viewer-count :global(.leading-zeros) {
    color: var(--phosphor-inactive) !important;
    text-shadow: none !important;
  }
</style>

<script>
  function formatCountWithLeadingZeros(count: number): string {
    const formatted = count.toString().padStart(3, "0");
    const leadingZeros = formatted.match(/^0+/)?.[0] || "";
    const actualNumber = formatted.slice(leadingZeros.length);

    if (leadingZeros) {
      return `<span class="leading-zeros">${leadingZeros}</span>${actualNumber}`;
    }
    return actualNumber;
  }

  class ViewerCount extends HTMLElement {
    private socket: WebSocket | null = null;

    connectedCallback(): void {
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const url = `${protocol}//${window.location.host}/api/visitors`;

      this.socket = new WebSocket(url);

      this.socket.addEventListener("message", (event) => {
        const count = parseInt(event.data) || 1;
        const countElement = this.querySelector(".count");
        if (countElement) {
          countElement.innerHTML = formatCountWithLeadingZeros(count);
        }
      });

      this.socket.addEventListener("close", () => {
        this.socket = null;
      });
    }

    disconnectedCallback(): void {
      if (this.socket) {
        this.socket.close();
        this.socket = null;
      }
    }
  }

  if (!customElements.get("viewer-count")) {
    customElements.define("viewer-count", ViewerCount);
  }
</script>
