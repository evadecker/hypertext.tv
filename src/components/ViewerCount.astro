<viewer-count transition:persist>
  <span class="count"><span class="leading-zeros">00</span>1</span> watching
</viewer-count>

<style>
  viewer-count {
    display: flex;
    align-items: center;
    gap: 0.4em;
    color: var(--phosphor-active);
    text-shadow: var(--phosphor-glow);
  }

  :global([data-power="off"]) viewer-count {
    color: var(--phosphor-inactive);
    text-shadow: none;
  }

  viewer-count :global(.leading-zeros) {
    color: var(--phosphor-inactive) !important;
    text-shadow: none !important;
  }
</style>

<script>
  function formatCountWithLeadingZeros(count: number): string {
    const formatted = count.toString().padStart(3, "0");
    const leadingZeros = formatted.match(/^0+/)?.[0] || "";
    const actualNumber = formatted.slice(leadingZeros.length);

    if (leadingZeros) {
      return `<span class="leading-zeros">${leadingZeros}</span>${actualNumber}`;
    }
    return actualNumber;
  }

  class ViewerCount extends HTMLElement {
    private socket: WebSocket | null = null;
    private isConnecting = false;

    connectedCallback(): void {
      // Skip WebSocket connection in development
      if (import.meta.env.DEV) {
        return;
      }

      // Prevent duplicate connections if connectedCallback is called multiple times
      if (this.socket || this.isConnecting) {
        return;
      }

      this.connect();
    }

    private connect(): void {
      // Close any existing socket first (defensive)
      if (this.socket) {
        this.socket.close();
        this.socket = null;
      }

      this.isConnecting = true;
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const url = `${protocol}//${window.location.host}/api/viewers`;

      try {
        this.socket = new WebSocket(url);

        this.socket.addEventListener("open", () => {
          this.isConnecting = false;
        });

        this.socket.addEventListener("message", (event) => {
          const count = parseInt(event.data) || 1;
          const countElement = this.querySelector(".count");
          if (countElement) {
            countElement.innerHTML = formatCountWithLeadingZeros(count);
          }
        });

        this.socket.addEventListener("close", () => {
          this.socket = null;
          this.isConnecting = false;
        });

        this.socket.addEventListener("error", () => {
          this.socket = null;
          this.isConnecting = false;
        });
      } catch (error) {
        this.socket = null;
        this.isConnecting = false;
      }
    }

    disconnectedCallback(): void {
      if (this.socket) {
        this.socket.close();
        this.socket = null;
      }
      this.isConnecting = false;
    }
  }

  if (!customElements.get("viewer-count")) {
    customElements.define("viewer-count", ViewerCount);
  }

  document.addEventListener("astro:after-swap", () => {
    const viewerCount = document.querySelector("viewer-count") as ViewerCount;
    if (viewerCount) viewerCount.disconnectedCallback();
  });
</script>
